# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  # Django - usando Secrets y Variables
  # Para producción, configure DJANGO_SECRET_KEY en GitHub Secrets
  SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY || 'insecure-ci-secret-key-for-testing-only' }}
  DEBUG: ${{ vars.DEBUG || 'False' }}
  ALLOWED_HOSTS: ${{ vars.ALLOWED_HOSTS || 'localhost,127.0.0.1' }}
  # Database - usando Secrets y Variables
  POSTGRES_USER: ${{ vars.POSTGRES_USER || 'sportsclub' }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || 'sportsclub' }}
  POSTGRES_DB: ${{ vars.POSTGRES_DB || 'sportsclub' }}
  POSTGRES_HOST: ${{ vars.POSTGRES_HOST || 'localhost' }}
  POSTGRES_PORT: ${{ vars.POSTGRES_PORT || '5432' }}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Ruff linter
        run: ruff check .

      - name: Run Ruff formatter check
        run: ruff format --check .

      - name: Verify dependency integrity
        run: |
          # Install compatible pip version for pip-tools
          # pip-tools 7.5.2 requires pip < 24 due to 'allow_all_prereleases' attribute
          python -m pip install "pip<24"

          # Install pip-tools for dependency verification
          pip install pip-tools

          # Check that requirements.txt is up-to-date with requirements.in
          echo "Verifying requirements.txt..."
          pip-compile --generate-hashes --allow-unsafe --no-header --output-file=requirements.txt.new requirements.in
          if ! diff -u requirements.txt requirements.txt.new; then
            echo "ERROR: requirements.txt is out of date."
            echo "Please run: pip-compile --generate-hashes --allow-unsafe --no-header requirements.in"
            exit 1
          fi

          # Check that requirements-dev.txt is up-to-date with requirements-dev.in
          echo "Verifying requirements-dev.txt..."
          pip-compile --generate-hashes --allow-unsafe --no-header --output-file=requirements-dev.txt.new requirements-dev.in
          if ! diff -u requirements-dev.txt requirements-dev.txt.new; then
            echo "ERROR: requirements-dev.txt is out of date."
            echo "Please run: pip-compile --generate-hashes --allow-unsafe --no-header requirements-dev.in"
            exit 1
          fi

          # Verify hashes are present in both files
          echo "Verifying cryptographic hashes..."
          if ! grep -q "^[^#].*--hash=sha256:" requirements.txt; then
            echo "ERROR: requirements.txt missing cryptographic hashes."
            exit 1
          fi
          if ! grep -q "^[^#].*--hash=sha256:" requirements-dev.txt; then
            echo "ERROR: requirements-dev.txt missing cryptographic hashes."
            exit 1
          fi

          echo "✓ All dependency files are up-to-date and have cryptographic hashes."

  test:
    name: Test
    runs-on: ubuntu-latest
    env:
      DEBUG: "True"

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: ${{ vars.POSTGRES_USER || 'sportsclub' }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || 'sportsclub' }}
          POSTGRES_DB: ${{ vars.POSTGRES_DB || 'sportsclub' }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U ${{ vars.POSTGRES_USER || 'sportsclub' }}"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          # Ensure compatible pip version for hash verification
          python -m pip install "pip<24"
          pip install --require-hashes -r requirements.txt


      - name: Run migrations
        working-directory: ./sportsclub
        run: python manage.py migrate

      - name: Run tests
        working-directory: ./sportsclub
        run: python manage.py test --verbosity=2

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        working-directory: ./sportsclub
        run: |
          python -m pip install "pip<24"
          pip install --require-hashes -r ../requirements.txt

      - name: Django security check
        working-directory: ./sportsclub
        run: python manage.py check --deploy

      - name: Install security tools
        run: |
          python -m venv security-venv
          echo "$PWD/security-venv/bin" >> $GITHUB_PATH
          source security-venv/bin/activate
          pip install --upgrade pip
          pip install --timeout 60 'tomli>=2.2.1' bandit safety pip-audit || echo "Failed to install tomli/bandit/safety/pip-audit"
          pip install --timeout 60 trufflehog || echo "Failed to install trufflehog"
          pip install --timeout 60 semgrep || echo "Failed to install semgrep"
          # Download and install gitleaks binary
          curl -L -H 'Accept: application/octet-stream' -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-linux-amd64 -o gitleaks
          chmod +x gitleaks
          file gitleaks || echo "Could not determine file type"
          mkdir -p ~/.local/bin
          mv gitleaks ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          # Verify installations
          python -c "import bandit; print('bandit version:', bandit.__version__)" || true
          python -c "import pkg_resources; print(pkg_resources.get_distribution('safety').version)" || true
          python -c "import pip_audit; print('pip-audit version:', pip_audit.__version__)" || true
          gitleaks version || echo "Failed to verify gitleaks"

      - name: Bandit scan
        run: |
          cd sportsclub
          bandit -r . --severity-level high --format json --output ../bandit-report.json

      - name: Safety dependency scan
        run: |
          safety check --output=json --output=safety-report.json

      - name: Pip-audit vulnerability scan
        run: |
          pip-audit --desc on --format json --output pip-audit-report.json --exit-on-severity critical

      - name: TruffleHog secrets scan
        run: |
          trufflehog filesystem --directory=. --json --output trufflehog-report.json || echo '{"errors": ["TruffleHog scan failed"]}' > trufflehog-report.json

      - name: Gitleaks secrets scan
        run: |
          gitleaks detect --source=. --report-format=json --report-path=gitleaks-report.json --verbose || echo '{"errors": ["Gitleaks scan failed"]}' > gitleaks-report.json

      - name: Semgrep static analysis
        run: |
          semgrep scan --config=auto --json --output semgrep-report.json --no-error || echo '{"errors": ["Semgrep scan failed"]}' > semgrep-report.json

      - name: Bearer data flow security scan
        run: |
          # Install Bearer CLI
          curl -sfL https://raw.githubusercontent.com/Bearer/bearer/main/install.sh | sh
          echo "$HOME/.bearer/bin" >> $GITHUB_PATH
          # Run Bearer scan focusing on data flow and PII
          bearer scan . \
            --skip-path "venv/**,**/migrations/**,**/__pycache__/**" \
            --format json \
            --output bearer-report.json \
            --severity high,medium \
            --report security \
            --exit-zero || echo '{"errors": ["Bearer scan failed"]}' > bearer-report.json

      - name: Trivy vulnerability scan
        run: |
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          # Run Trivy filesystem scan for vulnerabilities
          trivy fs --scanners vuln . \
            --skip-dirs "venv,docker,node_modules" \
            --format json \
            --output trivy-report.json \
            --exit-code 0 || echo '{"errors": ["Trivy scan failed"]}' > trivy-report.json

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 7

      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-security-report
          path: safety-report.json
          retention-days: 7

      - name: Upload Pip-audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-security-report
          path: pip-audit-report.json
          retention-days: 7

      - name: Upload TruffleHog report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trufflehog-security-report
          path: trufflehog-report.json
          retention-days: 7

      - name: Upload Gitleaks report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-security-report
          path: gitleaks-report.json
          retention-days: 7

      - name: Upload Semgrep report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-security-report
          path: semgrep-report.json
          retention-days: 7

      - name: Upload Bearer report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bearer-security-report
          path: bearer-report.json
          retention-days: 7

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-security-report
          path: trivy-report.json
          retention-days: 7

      - name: Check critical vulnerabilities
        if: always()
        run: |
          # Check pip-audit report for critical vulnerabilities
          if [ -f pip-audit-report.json ]; then
            CRITICAL_COUNT=$(jq '[.vulnerabilities[] | select(.severity == "CRITICAL")] | length' pip-audit-report.json 2>/dev/null || echo "0")
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "::error::Found $CRITICAL_COUNT CRITICAL vulnerabilities in pip-audit report"
              exit 1
            fi
          fi
          # Check safety report for high/critical vulnerabilities
          if [ -f safety-report.json ]; then
            if jq -e '.vulnerabilities | length > 0' safety-report.json 2>/dev/null; then
              echo "::error::Found vulnerabilities in safety report"
              exit 1
            fi
          fi

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build app image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/app/Dockerfile
          push: false
          tags: sportsclub-app:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [lint, test, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat <<EOF > .env
          SECRET_KEY=${{ env.SECRET_KEY }}
          DEBUG=${{ env.DEBUG }}
          ALLOWED_HOSTS=${{ env.ALLOWED_HOSTS }}
          POSTGRES_USER=${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ env.POSTGRES_DB }}
          POSTGRES_HOST=${{ env.POSTGRES_HOST }}
          POSTGRES_PORT=${{ env.POSTGRES_PORT }}
          EOF

      - name: Build and start services
        run: docker compose up -d --build

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services..."
          sleep 30
          docker compose ps

      - name: Run migrations in container
        run: |
          docker compose exec -T app-blue python manage.py migrate

      - name: Test API endpoint (blue)
        run: |
          curl -f http://localhost:8000/blue/api/v1/openapi.json || exit 1

      - name: Test API endpoint (green)
        run: |
          curl -f http://localhost:8000/green/api/v1/openapi.json || exit 1

      - name: Test main endpoint
        run: |
          curl -f http://localhost:8000/api/v1/openapi.json || exit 1

      - name: Show logs on failure
        if: failure()
        run: docker compose logs

      - name: Stop services
        if: always()
        run: docker compose down -v